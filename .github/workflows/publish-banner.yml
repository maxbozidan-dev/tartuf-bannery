name: Publish banner version

on:
  workflow_dispatch:
    inputs:
      target:
        description: "hlavni|doplnkovy1|doplnkovy2"
        required: true
      title:
        required: false
      subtitle:
        required: false
      ctaText:
        required: false
      ctaHref:
        required: false
      bgUrl:
        required: false

permissions:
  contents: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Resolve target + generate unique file name
        id: vars
        shell: bash
        run: |
          TS=$(date +%s)
          RAND=$(openssl rand -hex 3)
          KEY="${TS}${RAND}"

          TARGET_RAW="${{ github.event.inputs.target }}"
          TARGET="${TARGET_RAW#==}"

          case "$TARGET" in
            hlavni) PREFIX="hlavni-banner" ;;
            doplnkovy1) PREFIX="doplnkovy-banner-1" ;;
            doplnkovy2) PREFIX="doplnkovy-banner-2" ;;
            *) echo "Invalid target: $TARGET_RAW"; exit 1 ;;
          esac

          BASE_FILE="${PREFIX}.html"
          OUT_FILE="${PREFIX}-${KEY}.html"

          echo "base_file=$BASE_FILE" >> "$GITHUB_OUTPUT"
          echo "out_file=$OUT_FILE" >> "$GITHUB_OUTPUT"
          echo "publish_key=$KEY" >> "$GITHUB_OUTPUT"

      - name: Create published banner file
        shell: bash
        run: |
          cp "${{ steps.vars.outputs.base_file }}" "${{ steps.vars.outputs.out_file }}"

      - name: Write publish manifest
        shell: bash
        run: |
          mkdir -p .publish
          cat > ".publish/${{ github.event.inputs.target }}.json" <<EOF
          {
            "target": "${{ github.event.inputs.target }}",
            "file": "${{ steps.vars.outputs.out_file }}",
            "key": "${{ steps.vars.outputs.publish_key }}",
            "createdAt": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "inputs": {
              "title": "${{ github.event.inputs.title }}",
              "subtitle": "${{ github.event.inputs.subtitle }}",
              "ctaText": "${{ github.event.inputs.ctaText }}",
              "ctaHref": "${{ github.event.inputs.ctaHref }}",
              "bgUrl": "${{ github.event.inputs.bgUrl }}"
            }
          }
          EOF

      - name: Commit & push
        shell: bash
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "${{ steps.vars.outputs.out_file }}" .publish/
          git commit -m "publish: ${{ github.event.inputs.target }} -> ${{ steps.vars.outputs.out_file }}" || echo "No changes"
          git push